@model List<PhoneStore.Models.Product>
@{
    ViewData["Title"] = "Products";
    ViewData["ActiveMenu"] = "Products";

    string keyword = ViewBag.Keyword ?? "";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages  = ViewBag.TotalPages ?? 1;
    int pageSize    = ViewBag.PageSize ?? 6;
    decimal minPrice = ViewBag.MinPrice ?? 0m;          
    decimal maxPrice = ViewBag.MaxPrice ?? 50000000m;  

    int maxPagesToShow = 5; //số trang hiển thị tối đa
    int sort = ViewBag.Sort ?? 0; //trạng thái sắp xếp

    int startPage = Math.Max(1, currentPage - 2);
    int endPage   = Math.Min(totalPages, startPage + maxPagesToShow - 1);

    var categories = ViewBag.Categories as List<PhoneStore.Models.Category>;
    var selectedCategoryIds = ViewBag.SelectedCategoryIds as List<int> ?? new();
    var topSellingProducts = ViewBag.TopSellingProducts as List<PhoneStore.Models.Product>;

    if (endPage - startPage < maxPagesToShow - 1)
    {
        startPage = Math.Max(1, endPage - maxPagesToShow + 1);
    }
}

@functions {
    public string GetFirstImage(string imageString)
    {
        if (string.IsNullOrEmpty(imageString))
        {
            return "default.png";
        }
        var images = imageString.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
        return images.Length > 0 ? images[0].Trim() : "default.png";
    }
}

<!-- SECTION: Product List with Filter -->
<div class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">

            <!-- ASIDE: Filter Sidebar -->
            <div id="aside" class="col-md-3">

                <!-- Categories Filter -->
                <div class="aside">
                    <h3 class="aside-title">Categories</h3>
                    <div class="checkbox-filter">
                        @if (categories != null)
                        {
                            foreach (var category in categories)
                            {
                                var isChecked = selectedCategoryIds.Contains(category.category_id);
                                <div class="input-checkbox">
                                    <input type="checkbox"
                                        id="category-@category.category_id"
                                        @(isChecked ? "checked" : "")
                                        onchange="applyCategoryFilter()" />

                                    <label for="category-@category.category_id">
                                        <span></span>
                                        @category.category_name
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="aside">
                    <h3 class="aside-title">Price</h3>
                    <div class="price-filter">
                        <div class="input-number price-min">
                            <input id="price-min" type="text"  style="width:100%;padding:6px 8px;font-size:13px;text-align:center" value="@minPrice.ToString("N0")">
                        </div>
                        <span>-</span>
                        <div class="input-number price-max">
                            <input id="price-max" type="text"  style="width:100%;padding:6px 8px;font-size:13px;text-align:center" value="@maxPrice.ToString("N0")">
                        </div>
                        <button class="primary-btn"
                                style="margin-top:10px;width:100%"
                                onclick="applyPriceFilter()">
                            Apply
                        </button>
                    </div>
                </div>

                <!-- Brand Filter -->
                    @* <div class="aside">
                        <h3 class="aside-title">Brand</h3>
                        <div class="checkbox-filter">
                            <div class="input-checkbox">
                                <input type="checkbox" id="brand-1">
                                <label for="brand-1"><span></span>SAMSUNG <small>(578)</small></label>
                            </div>
                            <div class="input-checkbox">
                                <input type="checkbox" id="brand-2">
                                <label for="brand-2"><span></span>LG <small>(125)</small></label>
                            </div>
                            <div class="input-checkbox">
                                <input type="checkbox" id="brand-3">
                                <label for="brand-3"><span></span>SONY <small>(755)</small></label>
                            </div>
                            <!-- Thêm brand khác nếu cần -->
                        </div>
                    </div> *@

                <!-- Top Selling Widget (trong sidebar) -->
                <div class="aside">
                    <h3 class="aside-title">Top selling</h3>
                    @if (topSellingProducts != null && topSellingProducts.Any())
                    {
                        foreach (var product in topSellingProducts)
                        {
                            var finalPrice = product.discount_percent > 0
                            ? product.price * (100 - product.discount_percent) 
                            / 100 : product.price;

                            <div class="product-widget">
                                <div class="product-img">
                                    <img src="~/img/@GetFirstImage(product.image)" alt="@product.product_name">
                                </div>
                                <div class="product-body">
                                    <p class="product-category">@product.brand</p>
                                    <h3 class="product-name">
                                        <a asp-controller="Product"asp-action="Details"asp-route-id="@product.product_id">
                                            @product.product_name
                                        </a>
                                    </h3>
                                    <h4 class="product-price">
                                        @finalPrice.ToString("N0") VND
                                        @if (product.discount_percent > 0)
                                        {
                                            <del class="product-old-price">
                                                @product.price.ToString("N0") VND
                                            </del>
                                        }
                                    </h4>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No top selling products</p>
                    }
                </div>
                <!-- /Top Selling Widget -->

            </div>
            <!-- /ASIDE -->

            <!-- STORE: Main Product Grid -->
            <div id="store" class="col-md-9">
                <!-- Store Top Filter (Sort & View) -->
                <div class="store-filter clearfix">
                    <div class="store-sort">
                       <label>
                            Sort By:
                            <select class="input-select"
                                onchange="location.href='@Url.Action("Index","Product")'
                                + '?page=1'
                                + '&pageSize=@pageSize'
                                + '&sort=' + this.value
                                + '&categoryIds=@ViewBag.CategoryIds'
                                + '&minPrice=@ViewBag.MinPrice'
                                + '&maxPrice=@ViewBag.MaxPrice'
                                + '&keyword=@keyword'">
                                    
                                @if (sort == 0){
                                    <option value="0" selected>Popular</option>
                                }
                                else {
                                    <option value="0">Popular</option>
                                }

                                @if (sort == 1) {
                                    <option value="1" selected>Price: Low to High</option>
                                }
                                else{
                                    <option value="1">Price: Low to High</option>
                                }

                                @if (sort == 2) {
                                    <option value="2" selected>Price: High to Low</option>
                                }
                                else{
                                    <option value="2">Price: High to Low</option>
                                }
                            </select>
                        </label>
                        <label>
                            Show:
                            <select class="input-select"
                                onchange="location.href='@Url.Action("Index","Product")'
                                + '?page=1'
                                + '&pageSize=' + this.value
                                + '&sort=@sort'
                                + '&categoryIds=@ViewBag.CategoryIds'
                                + '&minPrice=@ViewBag.MinPrice'
                                + '&maxPrice=@ViewBag.MaxPrice'
                                + '&keyword=@keyword'">

                                @if (pageSize == 3){
                                    <option value="3" selected>3</option>
                                }
                                else{
                                    <option value="3">3</option>
                                }

                                @if (pageSize == 6){
                                    <option value="6" selected>6</option>
                                }
                                else{
                                    <option value="6">6</option>
                                }

                                @if (pageSize == 9){
                                    <option value="9" selected>9</option>
                                }
                                else{
                                    <option value="9">9</option>
                                }
                            </select>
                        </label>
                    </div>
                </div>
                <!-- /Store Top Filter -->

                <!-- Product Grid -->
                <div class="row">
                    @foreach(var item in Model)
                    {
                        <div class="col-md-4 col-xs-6">
                            <div class="product">
                                <div class="product-img">
                                    <img src="~/img/@GetFirstImage(item.image)" alt="@item.product_name">
                                    @if (item.discount_percent > 0)
                                    {
                                        <div class="product-label">
                                            <span class="sale">-@item.discount_percent%</span>
                                        </div>
                                    }
                                </div>
                                <div class="product-body">
                                    <p class="product-category">@item.brand</p>
                                    <h3 class="product-name">
                                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.product_id">
                                            @item.product_name
                                        </a>
                                    </h3>
                                    <h4 class="product-price">
                                        @((item.price * (100 - item.discount_percent)/100).ToString("N0")) VND
                                        @if (item.discount_percent > 0)
                                        {
                                            <del class="product-old-price">@item.price.ToString("N0") VND</del>
                                        }
                                    </h4>
                                </div>
                                <div class="add-to-cart">
                                    <form asp-controller="Order" asp-action="AddToCart" asp-route-id="@item.product_id" method="get" style="display:block;">
                                        <button class="add-to-cart-btn"><i class="fa fa-shopping-cart"></i> add to cart</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Store Bottom Filter -->
                <div class="store-filter clearfix">
                    <span class="store-qty">
                        Page @currentPage / @totalPages
                    </span>
                    <ul class="store-pagination">
                        @* Trang trước *@
                        @if (currentPage > 1)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = currentPage - 1, pageSize, sort, categoryIds = ViewBag.CategoryIds, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, keyword = keyword })">
                                    <i class="fa fa-angle-left"></i>
                                </a>
                            </li>
                        }
                        @* Nhảy về đầu *@
                        @if (startPage > 1)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product", new { page = 1, pageSize, sort, categoryIds = ViewBag.CategoryIds, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, keyword = keyword })">1</a>
                            </li>
                            <li class="disabled"><span>...</span></li>
                        }
                        @* Các trang chính (tối đa 5) *@
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="@(i == currentPage ? "active" : "")">
                                <a href="@Url.Action("Index","Product", new { page = i, pageSize, sort, categoryIds = ViewBag.CategoryIds, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, keyword = keyword })">@i
                                </a>
                            </li>
                        }
                        @* Nhảy về cuối *@
                        @if (endPage < totalPages)
                        {
                            <li class="disabled"><span>...</span></li>
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = totalPages, pageSize, sort, categoryIds = ViewBag.CategoryIds, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, keyword = keyword })">
                                    @totalPages
                                </a>
                            </li>
                        }
                        @* Trang sau *@
                        @if (currentPage < totalPages)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = currentPage + 1, pageSize, sort, categoryIds = ViewBag.CategoryIds, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, keyword = keyword })">
                                    <i class="fa fa-angle-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
                <!-- /Store Bottom Filter -->
            </div>
            <!-- /STORE -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /SECTION -->

@section Scripts {
<script>
    // Hàm áp dụng bộ lọc danh mục
    function applyCategoryFilter() {
        let selected = [];
        document.querySelectorAll('.checkbox-filter input[type="checkbox"]:checked')
            .forEach(cb => {
                selected.push(cb.id.replace('category-', ''));
            });

        let categoryIds = selected.join(',');

        let url = '@Url.Action("Index","Product")'
            + '?page=1'
            + '&pageSize=@ViewBag.PageSize'
            + '&sort=@ViewBag.Sort'
            + '&minPrice=@ViewBag.MinPrice'
            + '&maxPrice=@ViewBag.MaxPrice'
            + '&keyword=@keyword';


        if (categoryIds.length > 0) {
            url += '&categoryIds=' + categoryIds;
        }

        window.location.href = url;
    }

    // Hàm áp dụng bộ lọc giá
    function applyPriceFilter() {
        let minPrice = document.getElementById('price-min').value.replace(/\./g, '');
        let maxPrice = document.getElementById('price-max').value.replace(/\./g, '');

        let url = '@Url.Action("Index","Product")'
            + '?page=1'
            + '&pageSize=@ViewBag.PageSize'
            + '&sort=@ViewBag.Sort'
            + '&categoryIds=@ViewBag.CategoryIds'
            + '&keyword=@keyword';


        if (minPrice) url += '&minPrice=' + minPrice;
        if (maxPrice) url += '&maxPrice=' + maxPrice;

        window.location.href = url;
    }
    // Định dạng input giá tiền với dấu chấm
    function formatPriceInput(input) {
        input.value = input.value
        .replace(/\D/g, '')                // bỏ ký tự không phải số
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // thêm dấu .
    }
    document.getElementById('price-min').addEventListener('input', function () {
        formatPriceInput(this);
    });
    document.getElementById('price-max').addEventListener('input', function () {
        formatPriceInput(this);
    });

</script>
}

@model List<PhoneStore.Models.Product>
@{
    ViewData["Title"] = "Products";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages  = ViewBag.TotalPages ?? 1;
    int pageSize    = ViewBag.PageSize ?? 3;

    int maxPagesToShow = 5; //số trang hiển thị tối đa
    int sort = ViewBag.Sort ?? 0; //trạng thái sắp xếp

    int startPage = Math.Max(1, currentPage - 2);
    int endPage   = Math.Min(totalPages, startPage + maxPagesToShow - 1);

    if (endPage - startPage < maxPagesToShow - 1)
    {
        startPage = Math.Max(1, endPage - maxPagesToShow + 1);
    }
}

@functions {
    public string GetFirstImage(string imageString)
    {
        if (string.IsNullOrEmpty(imageString))
        {
            return "default.png";
        }
        var images = imageString.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
        return images.Length > 0 ? images[0].Trim() : "default.png";
    }
}

<!-- SECTION: Product List with Filter -->
<div class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">

            <!-- ASIDE: Filter Sidebar -->
            <div id="aside" class="col-md-3">

                <!-- Categories Filter -->
                <div class="aside">
                    <h3 class="aside-title">Categories</h3>
                    <div class="checkbox-filter">
                        <div class="input-checkbox">
                            <input type="checkbox" id="category-1">
                            <label for="category-1"><span></span>Laptops <small>(120)</small></label>
                        </div>
                        <div class="input-checkbox">
                            <input type="checkbox" id="category-2">
                            <label for="category-2"><span></span>Smartphones <small>(740)</small></label>
                        </div>
                        <div class="input-checkbox">
                            <input type="checkbox" id="category-3">
                            <label for="category-3"><span></span>Cameras <small>(1450)</small></label>
                        </div>
                        <div class="input-checkbox">
                            <input type="checkbox" id="category-4">
                            <label for="category-4"><span></span>Accessories <small>(578)</small></label>
                        </div>
                        <!-- Thêm các category khác nếu cần -->
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="aside">
                    <h3 class="aside-title">Price</h3>
                    <div class="price-filter">
                        <div id="price-slider"></div>
                        <div class="input-number price-min">
                            <input id="price-min" type="number">
                            <span class="qty-up">+</span>
                            <span class="qty-down">-</span>
                        </div>
                        <span>-</span>
                        <div class="input-number price-max">
                            <input id="price-max" type="number">
                            <span class="qty-up">+</span>
                            <span class="qty-down">-</span>
                        </div>
                    </div>
                </div>

                <!-- Brand Filter -->
                <div class="aside">
                    <h3 class="aside-title">Brand</h3>
                    <div class="checkbox-filter">
                        <div class="input-checkbox">
                            <input type="checkbox" id="brand-1">
                            <label for="brand-1"><span></span>SAMSUNG <small>(578)</small></label>
                        </div>
                        <div class="input-checkbox">
                            <input type="checkbox" id="brand-2">
                            <label for="brand-2"><span></span>LG <small>(125)</small></label>
                        </div>
                        <div class="input-checkbox">
                            <input type="checkbox" id="brand-3">
                            <label for="brand-3"><span></span>SONY <small>(755)</small></label>
                        </div>
                        <!-- Thêm brand khác nếu cần -->
                    </div>
                </div>

                <!-- Top Selling Widget (trong sidebar) -->
                <div class="aside">
                    <h3 class="aside-title">Top selling</h3>
                    <div class="product-widget">
                        <div class="product-img"><img src="/img/product01.png" alt=""></div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>
                    <div class="product-widget">
                        <div class="product-img"><img src="/img/product02.png" alt=""></div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>
                    <div class="product-widget">
                        <div class="product-img"><img src="/img/product03.png" alt=""></div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>
                </div>
                <!-- /Top Selling Widget -->

            </div>
            <!-- /ASIDE -->

            <!-- STORE: Main Product Grid -->
            <div id="store" class="col-md-9">
                <!-- Store Top Filter (Sort & View) -->
                <div class="store-filter clearfix">
                    <div class="store-sort">
                       <label>
                            Sort By:
                            <select class="input-select"
                                    data-url="@Url.Action("Index","Product")"
                                    onchange="location.href =this.dataset.url +'?page=1&pageSize=@pageSize&sort=' + this.value;">
                                    
                                @if (sort == 0){
                                    <option value="0" selected>Popular</option>
                                }
                                else {
                                    <option value="0">Popular</option>
                                }

                                @if (sort == 1) {
                                    <option value="1" selected>Price: Low to High</option>
                                }
                                else{
                                    <option value="1">Price: Low to High</option>
                                }

                                @if (sort == 2) {
                                    <option value="2" selected>Price: High to Low</option>
                                }
                                else{
                                    <option value="2">Price: High to Low</option>
                                }
                            </select>
                        </label>
                        <label>
                            Show:
                            <select class="input-select"
                                    data-url="@Url.Action("Index","Product")"
                                    onchange="location.href = this.dataset.url + '?page=1&pageSize=' + this.value;">
                                @if (pageSize == 3){
                                    <option value="3" selected>3</option>
                                }
                                else{
                                    <option value="3">3</option>
                                }

                                @if (pageSize == 6){
                                    <option value="6" selected>6</option>
                                }
                                else{
                                    <option value="6">6</option>
                                }

                                @if (pageSize == 9){
                                    <option value="9" selected>9</option>
                                }
                                else{
                                    <option value="9">9</option>
                                }
                            </select>
                        </label>
                    </div>
                    <ul class="store-grid">
                        <li class="active"><i class="fa fa-th"></i></li>
                        <li><a href="#"><i class="fa fa-th-list"></i></a></li>
                    </ul>
                </div>
                <!-- /Store Top Filter -->

                <!-- Product Grid -->
                <div class="row">
                    @foreach(var item in Model)
                    {
                        <div class="col-md-4 col-xs-6">
                            <div class="product">
                                <div class="product-img">
                                    <img src="~/img/@GetFirstImage(item.image)" alt="@item.product_name">
                                    @if (item.discount_percent > 0)
                                    {
                                        <div class="product-label">
                                            <span class="sale">-@item.discount_percent%</span>
                                        </div>
                                    }
                                </div>
                                <div class="product-body">
                                    <p class="product-category">@item.brand</p>
                                    <h3 class="product-name">
                                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.product_id">
                                            @item.product_name
                                        </a>
                                    </h3>
                                    <h4 class="product-price">
                                        @((item.price * (100 - item.discount_percent)/100).ToString("N0")) VND
                                        @if (item.discount_percent > 0)
                                        {
                                            <del class="product-old-price">@item.price.ToString("N0") VND</del>
                                        }
                                    </h4>
                                </div>
                                <div class="add-to-cart">
                                    <button class="add-to-cart-btn"><i class="fa fa-shopping-cart"></i> add to cart</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Store Bottom Filter -->
                <div class="store-filter clearfix">
                    <span class="store-qty">
                        Page @currentPage / @totalPages
                    </span>
                    <ul class="store-pagination">
                        @* Trang trước *@
                        @if (currentPage > 1)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = currentPage - 1, pageSize, sort })">
                                    <i class="fa fa-angle-left"></i>
                                </a>
                            </li>
                        }
                        @* Nhảy về đầu *@
                        @if (startPage > 1)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product", new { page = 1, pageSize, sort })">1</a>
                            </li>
                            <li class="disabled"><span>...</span></li>
                        }
                        @* Các trang chính (tối đa 5) *@
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="@(i == currentPage ? "active" : "")">
                                <a href="@Url.Action("Index","Product", new { page = i, pageSize, sort })">@i
                                </a>
                            </li>
                        }
                        @* Nhảy về cuối *@
                        @if (endPage < totalPages)
                        {
                            <li class="disabled"><span>...</span></li>
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = totalPages, pageSize, sort })">
                                    @totalPages
                                </a>
                            </li>
                        }
                        @* Trang sau *@
                        @if (currentPage < totalPages)
                        {
                            <li>
                                <a href="@Url.Action("Index","Product",new { page = currentPage + 1, pageSize, sort })">
                                    <i class="fa fa-angle-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
                <!-- /Store Bottom Filter -->
            </div>
            <!-- /STORE -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /SECTION -->

@section Scripts {
    <!-- Nếu trang này cần script riêng (ví dụ: nouislider cho price filter) -->
    <script>
        // Khởi tạo price slider nếu dùng nouislider
        // $(function () { ... });
    </script>
}
@using PhoneStore.Models
@model List<Product>

@{
	ViewData["Title"] = "Danh sách sản phẩm";
}

<div id="page-wrapper">
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-12">
				<div class="header-section">
					<h1 class="page-header">
						<i class="fa fa-mobile"></i> Quản lý sản phẩm
					</h1>
					<div class="search-box">
						<input type="text" 
							id="searchInput" 
							placeholder="Tìm kiếm sản phẩm..." 
							value="@ViewBag.Search" />
						<i class="fa fa-search"></i>
					</div>

				</div>
			</div>
		</div>

		@if (TempData["SuccessMessage"] != null)
		{
			<div class="alert alert-success">
				@TempData["SuccessMessage"]
			</div>
		}

		<div class="row">
			<div class="col-lg-12">
				<div class="panel panel-default">
					<div class="panel-heading">
						<i class="fa fa-list"></i> Danh sách sản phẩm
					</div>
					<div class="panel-body">
						<table class="table table-striped table-bordered">
			<thead>
				<tr>
					<th>Mã sản phẩm</th>
					<th>Tên sản phẩm</th>
					<th>Danh mục</th>
					<th>Giá</th>
					<th>Giảm giá (%)</th>
					<th>Tồn kho</th>
					<th>Hình ảnh</th>
					<th>Mô tả</th>
					<th>Trạng thái</th>
					<th>Ngày tạo</th>
					<th>Hành động</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var product in Model)
				{
					<tr>
						<td>@product.product_id</td>
						<td>@product.product_name</td>
						<td>@product.category_id</td>
						<td>@product.price.ToString("N0") VNĐ</td>
						<td>@product.discount_percent%</td>
						<td>@product.stock_quantity</td>
						<td>
							@if (!string.IsNullOrEmpty(product.image))
							{
								<img src="~/admin/img/@product.image" alt="@product.product_name" />
							}
							else
							{
								<span class="text-muted">Không có ảnh</span>
							}
						</td>
						<td>@(product.description.Length > 50 ? product.description.Substring(0, 50) + "..." : product.description)</td>
						<td>
							@if (product.status == 1)
							{
								<span class="label label-success">Hiển thị</span>
							}
							else
							{
								<span class="label label-danger">Ẩn</span>
							}
						</td>
						<td>@product.created_at.ToString("dd/MM/yyyy")</td>
						<td>
						<div class="action-buttons">
							<a asp-area="Admin" asp-controller="Product" asp-action="EditProduct" asp-route-id="@product.product_id" class="btn btn-sm btn-primary">
								<i class="fa fa-edit"></i> Cập nhật
							</a>
							<button type="button" class="btn btn-sm btn-danger" onclick="deleteProduct(@product.product_id)">
								<i class="fa fa-trash"></i> Xóa
							</button>
						</div>
						</td>
					</tr>
				}
			</tbody>
		</table>

		@* Phân trang *@
		@if (ViewBag.TotalPages > 1)
		{
			<div class="pagination-wrapper">
				<ul class="pagination">
					@if (ViewBag.Page > 1)
					{
						<li><a asp-area="Admin" asp-controller="Product" asp-action="Index" asp-route-page="@(ViewBag.Page - 1)">« Trước</a></li>
					}
					
					@for (int i = 1; i <= ViewBag.TotalPages; i++)
					{
						<li class="@(i == ViewBag.Page ? "active" : "")">
							<a asp-area="Admin" asp-controller="Product" asp-action="Index" asp-route-page="@i">@i</a>
						</li>
					}
					
					@if (ViewBag.Page < ViewBag.TotalPages)
					{
						<li><a asp-area="Admin" asp-controller="Product" asp-action="Index" asp-route-page="@(ViewBag.Page + 1)">Sau »</a></li>
					}
				</ul>
			</div>
		}
					</div>
				</div>
			</div>
		</div>
	</div>

	<a class="floating-add-button" asp-area="Admin" asp-controller="Product" asp-action="AddProduct">
		<i class="fa fa-plus"></i> Thêm sản phẩm
	</a>
</div>

@section Scripts {
	<script>
		function deleteProduct(id) {
			if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
				fetch('@Url.Action("DeleteProduct", "Product", new { area = "Admin" })?id=' + id, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						alert(data.message);
						location.reload();
					} else {
						alert(data.message);
					}
				})
				.catch(error => {
					alert('Có lỗi xảy ra: ' + error);
				});
			}
		}

		// Tìm kiếm khi nhấn Enter
		document.getElementById('searchInput')
		.addEventListener('keypress', function (e) {
			if (e.key === 'Enter') {
				let keyword = this.value.trim();
				let url = '@Url.Action("Index","Product", new { area = "Admin" })';

				if (keyword !== '') {
					url += '?search=' + encodeURIComponent(keyword);
				}

				window.location.href = url;
			}
		});
	</script>
}
